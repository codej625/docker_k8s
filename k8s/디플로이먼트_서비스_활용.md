# 디플로이먼트와 서비스를 활용해보자.

<br />
<br />

* 디플로이먼트, 서비스를 활용해 백엔드(Nest.js) 서버 띄워보기

---

```
* 요구 사항 정리

1) 디플로이먼트(Deployment) -> 파드 4개 띄우기
2) 서비스(Service) -> http://localhost:3001 에서 통신할 수 있도록 만들기
```

<br />
<br />
<br />
<br />

1. Nest.js 프로젝트 만들기

```
이번에는 AWS 의 종류를 Spring이 아닌,
Nest.js 를 사용한다.
```

```
# nest new {프로젝트명}
$ nest new nest-server
```

<br />
<br />
<br />

2. 프로젝트 실행시켜보기

```
$ npm i
$ npm run start
```

<br />
<br />
<br />

3. Dockerfile 작성하기

<br />

`Dockerfile`

```Dockerfile
FROM node

WORKDIR /app

COPY . .

RUN npm install

RUN npm run build

EXPOSE 3000

ENTRYPOINT [ "node", "dist/main.js" ]
```

<br />
<br />
<br />

4. .dockerignore 작성하기

<br />

`.dockerignore`

```
# 제외할 folder 혹은 file 추가
node_modules
```

<br />
<br />
<br />

5. Dockerfile을 바탕으로 이미지 빌드하기

```
# 1.0으로 버전을 명시
$ docker build -t nest-server:1.0 .
```

<br />
<br />
<br />

6. 이미지가 잘 생성됐는 지 확인하기

```
# 도커 이미지 확인
$ docker image ls
```

<br />
<br />
<br />

7. 매니페스트 파일 생성하기

<br />

`nest-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment

# Deployment 기본 정보
metadata:
  name: nest-deployment # Deployment 이름
  # Deployment 세부 정보
  spec:
    replicas: 4 # 생성할 파드의 복제본 개수
    selector:
      matchLabels:
        app: backend-app # 아래에서 정의한 Pod 중 'app: backend-app'이라는 값을 가진 파드를 선택
    # 배포할 Pod 정의
    template:
      metadata:
        labels: # 레이블 (= 카테고리)
          app: backend-app
      spec:
        containers:
          - name: nest-container # 컨테이너 이름
            image: nest-server:1.0 # 컨테이너를 생성할 때 사용할 이미지
            imagePullPolicy: IfNotPresent # 로컬에서 이미지를 먼저 가져온다. 없으면 레지스트리에서 가져온다.
            ports:
            - containerPort: 3000 # 컨테이너에서 사용하는 포트를 명시적으로 표현
```

<br />

`nest-service.yaml`

```yaml
apiVersion: v1
kind: Service

# Service 기본 정보
metadata:
  name: nest-service

# Service 세부 정보
spec:
  type: NodePort # Service의 종류
    selector:
      app: backend-app # 실행되고 있는 파드 중 'app: backend-app'이라는 값을 가진 파드와 서비스를 연결
    ports:
      - protocol: TCP # 서비스에 접속하기 위한 프로토콜
      nodePort: 31000 # 외부에서 사용자들이 접근하게 될 포트 번호
      port: 3000 # 쿠버네티스 내부에서 Service에 접속하기 위한 포트 번호
      targetPort: 3000 # 매핑하기 위한 파드의 포트 번호
```

<br />
<br />
<br />

8. 매니페스트 파일 기반으로 오브젝트 생성

```
$ kubectl apply -f nest-deployment.yaml
$ kubectl apply -f nest-service.yaml
```

<br />
<br />
<br />

9. 업데이트 하기
  
```
* 요구 사항

백엔드 서버 띄운 이후에 Hello World! 라고 응답하는 서버를
test 라고 응답하는 서버로 업데이트
```

<br />

`app.service.ts`

```ts
// Nest.js 코드 수정하기

import { Injectable } from '@nestjs/common';

@Injectable()
export class AppService {
  getHello(): string {
    return 'test';
  }
}
```

<br />
<br />
<br />

10. 이미지 새로 빌드하기

```
# 버전을 1.1으로 변경
$ docker build -t nest-server:1.1 .
```

<br />
<br />
<br />

11. 매니페스트 파일 수정하기

<br />

`nest-deployment.yaml`

```yaml

...

# 배포할 Pod 정의
template:
  metadata:
    labels:
      app: backend-app
  
  spec:
    containers:
      - name: nest-container
      image: nest-server:1.1 # 컨테이너를 생성할 때 사용할 이미지 이름 변경
      imagePullPolicy: IfNotPresent
      ports:
      - containerPort: 3000
```

<br />
<br />
<br />

12. 수정된 매니페스트 파일 적용

```
# 수정된 매니페스트 파일을 적용한다.
$ kubectl apply -f nest-deployment.yaml
```
