# 마스터 노드를 다운시키는 문제들

<br />
<br />

* 마스터 노드가 다운되면?

---

| 장애 유형 | 마스터 노드 사망 시 발생하는 현상 (뇌사 상태) |
| :--- | :--- |
| **자가 치유 불가**<br>(Self-healing) | 파드가 죽어도 이를 감지하고 다시 띄워줄 관리자가 없어, 시간이 지날수록 서비스가 서서히 멈춤. |
| **운영/배포 마비**<br>(Operation) | API 서버 다운으로 `kubectl` 명령이 먹통이 되어, 긴급 패치나 설정 변경 등 모든 제어가 불가능함. |
| **스케일링 실패**<br>(Auto Scaling) | 트래픽 폭주 시 파드를 늘려줄(HPA) 주체가 없어, 기존 파드들이 과부하를 견디지 못하고 연쇄적으로 터짐. |
| **네트워크 고립**<br>(Service Discovery) | 파드 IP 정보(DNS/Endpoint)가 갱신되지 않아, 트래픽이 이미 죽은 파드로 향하거나 새 파드를 찾지 못함. |

<br />
<br />
<br />
<br />

1. k3s 디스크 관리 및 안정성 설정 (스냅샷, 로그, 이미지)

```
마스터 노드(겸 워커)의 디스크가 가득 차서 서버가 멈추는 것을 방지하기 위한 필수 설정이다.

스냅샷 과다 누적, 사용하지 않는 이미지, 컨테이너 로그 폭탄을 방지한다.
```

<br />

`sudo vim /etc/systemd/system/k3s.service`

```
# ExecStart 부분을 찾아 아래 옵션들을 추가한다.
# (기존 설정 뒤에 이어 붙이되, 줄바꿈 역슬래시 \ 주의)

ExecStart=/usr/local/bin/k3s \
    server \
    # [1. DB 스냅샷 관리]
    # 스냅샷을 12시간마다 생성하고, 최근 5개만 보관
    --etcd-snapshot-retention 5 \
    --etcd-snapshot-schedule-cron "0 */12 * * *" \
    \
    # [2. 사용 안 하는 이미지 청소 (Image GC)]
    # 디스크 85% 차면 청소 시작, 80% 될 때까지 삭제
    --kubelet-arg="image-gc-high-threshold=85" \
    --kubelet-arg="image-gc-low-threshold=80" \
    \
    # [3. 컨테이너 로그 폭탄 방지 (Log Rotation)] ★제일 중요★
    # 로그 파일 하나당 10MB 제한, 최대 5개 보관 (총 50MB 제한)
    --kubelet-arg="container-log-max-files=5" \
    --kubelet-arg="container-log-max-size=10Mi" \
```

<br />

`k3s 설정 적용 및 재시작`

```
설정 파일을 수정한 후에는 데몬을 리로드하고,
서비스를 재시작해야 적용된다.
```

```zsh
# 변경된 systemd 설정 파일 읽어오기
sudo systemctl daemon-reload

# k3s 서비스 재시작 (잠시 연결 끊김)
sudo systemctl restart k3s

# 적용된 옵션 확인
ps -ef | grep k3s
```

<br />
<br />
<br />

2. 디스크 용량 분석 도구 (ncdu)

```
서버 디스크가 갑자기 꽉 찼을 때, 어떤 폴더가 용량을 차지하는지
윈도우 탐색기처럼 시각적으로 찾아주는 도구이다. (필수 유틸리티)
```

```zsh
# 설치
sudo apt install ncdu -y

# 전체 디스크 스캔 (루트 권한 필요)
# 실행 후 방향키로 이동하며 용량 확인 가능
sudo ncdu /
```
