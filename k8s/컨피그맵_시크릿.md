# 컨피그맵(ConfigMap)과 시크릿(secret)을 활용해 환경변수 분리하기

<br />
<br />

* 언제 사용할까?

---

```
Spring Boot에서는 설정값을 application.yml 으로 분리해서 관리한다.

Nest.js에서도 설정값을 .env 으로 분리해서 관리한다. 별도의 파일로 분리를 해서
관리함으로써 유지보수가 편리해지고 개발, 테스트, 프로덕션과 같은 환경 분리가 편해진다.

쿠버네티스에서는 파드(Pod), 디플로이먼트(Deployment), 서비스(Service)가 각각의 역할을 가지고 있는 것처럼
환경 변수를 관리하는 역할을 가진 오브젝트가 따로 존재한다.
그게 바로 컨피그맵(ConfigMap)이다.

여기서 시크릿(secret)은 비밀번호와 같은 보안적으로 중요한 값을 관리하기 위한 오브젝트이다.
```

<br />
<br />
<br />
<br />

1. 매니페스트 파일 수정

<br />

`spring-deployment.yaml`

```yaml

...

    spec:
      containers:
        - name: spring-container
          image: spring-server
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          
          # env: 기존 환경변수 값을 주석처리
          #   - name: MY_ACCOUNT
          #     value: "codej625"
          #   - name: MY_PASSWORD
          #     value: "1234"
          
          env:
            - name: MY_ACCOUNT
              valueFrom:
                configMapKeyRef:
                  name: spring-config
                  key: my-account
            - name: MY_PASSWORD
              valueFrom:
                configMapKeyRef:
                  name: spring-config
                  key: my-password
```

<br />
<br />
<br />

2. 컨피그맵 패니페스트 파일 적용

<br />

`spring-config.yaml`

```yaml
apiVersion: v1
kind: ConfigMap

metadata:
  name: spring-config

data:
  my-account: codej625
  my-password: "1234"
```

<br />

```
# 컨피그맵 적용
$ kubectl apply -f spring-config.yaml

# 디플로이먼트 적용
$ kubectl apply -f spring-deployment.yaml

# 디플로이먼트 재시작
$ kubectl rollout restart deployment spring-deployment # Deployment 재시작
```

<br />
<br />
<br />

3. 시크릿(Secret)을 활용해 민감한 값을 따로 분리하기

<br />

```
기존 매니페스트 파일에서 my_password 의 값이 보안적으로 중요한 값이라고 가정해보자.

그러면 my_password 의 값은 컨피그맵 (ConfigMap)이 아닌 시크릿 (Secret)으로 관리해야 한다.
```

<br />

`spring-secret.yaml`

```yaml
apiVersion: v1
kind: Secret

# Secret 기본 정보
metadata:
  name: spring-secret # Secret 이름
  
# Key, Value 형식으로 값 저장
stringData:
my-password: my-secret-password
```

<br />

`기존 spring-deployment.yaml 수정`

```yaml

...

    spec:
      containers:
        - name: spring-container
          image: spring-server
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8080
          
          # env: 기존 환경변수 값을 주석처리
          #   - name: MY_ACCOUNT
          #     value: "codej625"
          #   - name: MY_PASSWORD
          #     value: "1234"
          
          env:
            - name: MY_ACCOUNT
              valueFrom:
                configMapKeyRef:
                  name: spring-config
                  key: my-account
            - name: MY_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: spring-secret
                  key: my-password
```

<br />
<br />
<br />

4. 매니페스트 파일 반영하기

```
$ kubectl apply -f spring-secret.yaml
$ kubectl apply -f spring-config.yaml
$ kubectl apply -f spring-deployment.yaml
$ kubectl rollout restart deployment spring-deployment
```
