# 인그레스 컨트롤러 활용하기

<br />
<br />

* 쿠버네티스 환경에서 Ingress Controller를 사용한 외부 트래픽 처리

---

```
Ingress 리소스의 주된 목적은 Ingress Controller를 통해,
외부 트래픽을 클러스터 내부의 특정 Service 리소스와 연결하는 것이다.

VM을 사용해서 K3s 클러스터 구조를 만드는 예시이다.
(하나의 클러스터에 여러 개의 인스턴스 사용)
```

<br />
<br />
<br />
<br />

1. 생성할 VM 사양 (예시)

| VM  | 역할     | CPU    | RAM | DISK  | IP (고정) 예시  |
|:---:|----------|--------|-----|-------|-----------------|
| VM1	|	Master 1 | 2 Core | 2GB | 20GB  | 192.168.0.10    |
| VM2	| Worker 1 | 2 Core | 4GB | 50GB+ | 192.168.0.20    |
| VM3 | Worker 2 | 2 Core | 4GB | 50GB+ | 192.168.0.30    |

<br />
<br />
<br />

2. 각 VM 사전 설정

```zsh
# 호스트명 설정 (각 VM에서)
sudo hostnamectl set-hostname master-1 # VM1 에서 실행

sudo hostnamectl set-hostname worker-1 # VM2 에서 실행

sudo hostnamectl set-hostname worker-2 # VM3 에서 실행
```

```zsh
# /etc/hosts에 등록 (각 VM에서 IP는 예시)
sudo tee -a /etc/hosts << EOF
192.168.0.10 master-1
192.168.0.20 worker-1
192.168.0.30 worker-2
EOF
```

```zsh
# 방화벽 비활성화 (테스트 시)
sudo ufw disable

# 혹은 필요한 포트만 오픈

# Master 노드에서 (VM1)
sudo ufw allow 6443/tcp        # Kubernetes API
sudo ufw allow 10250/tcp       # Kubelet API
sudo ufw allow 2379:2380/tcp   # etcd
sudo ufw allow 80/tcp          # HTTP
sudo ufw allow 443/tcp         # HTTPS
sudo ufw enable

# Worker 노드에서 (VM2, VM3)
sudo ufw allow 10250/tcp           # Kubelet API
sudo ufw allow 30000:32767/tcp     # NodePort 범위
sudo ufw allow 80/tcp              # HTTP
sudo ufw allow 443/tcp             # HTTPS
sudo ufw enable
```

<br />
<br />
<br />

3. VM1에서 Master 1 설치

```zsh
# Traefik 비활성화 + TLS SAN 추가 (IP 변경 해야함)
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable=traefik --tls-san=192.168.0.10" sh -

# 설치 확인
sudo systemctl status k3s
kubectl get nodes

# 토큰 확인 (Worker 조인 시 필요 - 안전하게 보관)
sudo cat /var/lib/rancher/k3s/server/node-token
```

```zsh
# kubectl 권한 설정 (편의상)
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
```

```zsh
# Master에 Taint 추가 (워크로드는 Worker에만 배치)
# 먼저 현재 taint 확인
kubectl describe node master-1 | grep Taints

# taint 적용
kubectl taint nodes master-1 node-role.kubernetes.io/control-plane:NoSchedule --overwrite
```

<br />
<br />
<br />

4. VM2, VM3에서 K3s Worker 조인

<br />

`VM2, VM3에서 실행`

```zsh
# 환경변수로 깔끔하게
export K3S_URL="https://192.168.0.10:6443"
export K3S_TOKEN="<토큰값>"

curl -sfL https://get.k3s.io | sh -

# 설치 확인
sudo systemctl status k3s-agent
```

<br />

`VM1에서 조인 확인`

```zsh
# 노드 리스트 출력
kubectl get nodes
```

| NAME     | STATUS | ROLES                | AGE | VERSION | 
|----------|--------|----------------------|-----|---------|
| master   | Ready  | control-plane,master | 5m  | v1.30.x | 
| worker-1 | Ready  | <none>               | 2m  | v1.30.x |
| worker-2 | Ready  | <none>               | 1m  | v1.30.x | 

<br />
<br />
<br />

5. MetalLB 설치 (LoadBalancer 구현)

```zsh
# MetalLB 최신 버전 설치 (Native 모드)
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml

# Pod들이 Ready 상태가 될 때까지 대기
kubectl wait --namespace metallb-system \
  --for=condition=ready pod \
  --selector=app=metallb \
  --timeout=90s
```

<br />

`metallb-config.yaml`

```yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
  - 192.168.0.240-192.168.0.250 # 로드밸런서가 사용할 가상 IP(VIP) 범위
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: example
  namespace: metallb-system
spec:
  ipAddressPools:
  - first-pool
```

```zsh
# 설정 적용
kubectl apply -f metallb-config.yaml

# MetalLB 상태 확인
kubectl get pods -n metallb-system
kubectl get ipaddresspool -n metallb-system
```

<br />
<br />
<br />

6. NGINX Ingress Controller 설치

```zsh
# 최신 버전 설치 (2025년 기준 v1.12.0+)
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.12.0/deploy/static/provider/baremetal/deploy.yaml

# Pod 준비 대기
kubectl wait --namespace ingress-nginx \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/component=controller \
  --timeout=120s

# LoadBalancer 타입으로 변경 (MetalLB가 VIP 할당)
kubectl patch svc ingress-nginx-controller -n ingress-nginx -p '{"spec": {"type": "LoadBalancer"}}'
```

```zsh
# 설치 확인
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx

# EXTERNAL-IP에 192.168.0.240-250 범위의 IP가 할당되었는지 확인
```

<br />
<br />
<br />

7. cert-manager 설치 (HTTPS/TLS 인증서 자동 관리)

```zsh
# cert-manager 설치
kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.16.2/cert-manager.yaml

# 준비 대기
kubectl wait --namespace cert-manager \
  --for=condition=ready pod \
  --selector=app.kubernetes.io/instance=cert-manager \
  --timeout=90s
```

<br />

`letsencrypt-issuer.yaml`

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com  # 본인 이메일로 변경 필수
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
```

```zsh
kubectl apply -f letsencrypt-issuer.yaml

# ClusterIssuer 상태 확인
kubectl get clusterissuer
```

<br />
<br />
<br />

8. Backend Service 설정

<br />

`ex) backend-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: default
spec:
  type: ClusterIP # 내부 통신용 (Ingress가 라우팅)
  selector:
    app: backend # Deployment의 label과 일치해야 함
  ports:
  - name: http
    port: 80 # 서비스 포트
    targetPort: 8080 # 컨테이너 포트
    protocol: TCP
```

```zsh
kubectl apply -f backend-service.yaml

# 서비스 확인
kubectl get svc backend-service
```

<br />
<br />
<br />

9. DB Service 설정 (외부 DBA 접근 가능)

<br />

`ex) database-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: database-service
  namespace: default
spec:
  type: NodePort # 외부에서 DBeaver 등 DB 클라이언트 접근용
  selector:
    app: database # Deployment의 label과 일치해야 함
  ports:
  - name: postgres
    port: 5432 # 서비스 포트
    targetPort: 5432 # 컨테이너 포트
    nodePort: 30432 # 외부 접근 포트 (30000-32767 범위)
    protocol: TCP
```

```zsh
kubectl apply -f database-service.yaml

# 서비스 확인
kubectl get svc database-service
```

<br />
<br />
<br />

10. Ingress 라우팅 설정

<br />

`ex) ingress.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    # HTTPS 강제 리다이렉트
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    # cert-manager를 통한 자동 인증서 발급
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  ingressClassName: nginx
  tls:
  - hosts:
    - healthapp.shop
    secretName: healthapp-tls # cert-manager가 자동으로 생성
  rules:
  - host: healthapp.shop
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
```

```zsh
kubectl apply -f ingress.yaml

# Ingress 확인
kubectl get ingress
kubectl describe ingress main-ingress

# TLS 인증서 발급 확인 (최대 2-3분 소요)
kubectl get certificate
kubectl describe certificate healthapp-tls
```

<br />
<br />
<br />

11. 도메인 DNS 설정

```
도메인 구입처(가비아, 호스팅케이알 등)의 DNS 관리 메뉴에서
A 레코드를 추가한다.

DNS 전파는 보통 수분에서 최대 24시간까지 소요될 수 있다.
```

<br />

| 구분      | 설명            |
|-----------|-----------------|
| 도메인     | healthapp.shop |
| 레코드     | A              |
| 호스트     | @              |
| 값(IP주소) | 공인IP         |
| TTL        | 3600 (1시간)   |  

```zsh
# DNS 전파 확인
nslookup healthapp.shop
dig healthapp.shop
```

<br />
<br />
<br />

12. 공유기 포트포워딩 설정

```
공유기 관리자 페이지에서 다음과 같이 포트포워딩을 설정한다.
(공유기마다 설정 메뉴 위치가 다를 수 있음)

주의: 일부 ISP는 80/443 포트를 차단할 수 있으므로,
차단되는 경우 8080, 8443 등 다른 포트를 사용하고
도메인에서 포트 번호를 명시해야 한다.
```

<br />

| 외부 포트 | 내부 IP         | 내부 포트 | 프로토콜 | 설명          |
|-----------|-----------------|------------|----------|---------------|
| 80        | 192.168.0.240   | 80         | TCP      | HTTP 트래픽   |
| 443       | 192.168.0.240   | 443        | TCP      | HTTPS 트래픽  |

<br />
<br />
<br />

13. 전체 시스템 확인

```zsh
# 모든 리소스 상태 확인
kubectl get all -A

# Ingress 상태 및 할당된 IP 확인
kubectl get ingress -A

# LoadBalancer 서비스 IP 확인
kubectl get svc -n ingress-nginx

# TLS 인증서 상태 확인
kubectl get certificate -A

# Ingress Controller 로그 확인
kubectl logs -n ingress-nginx -l app.kubernetes.io/name=ingress-nginx --tail=100

# MetalLB 로그 확인
kubectl logs -n metallb-system -l app=metallb --tail=50
```

<br />
<br />
<br />

14. 팁

```
* 클러스터 내부에서 Service 이름으로 연결

백엔드에서 디비 서버를 붙일때는
서비스 이름으로 지정해놓으면 된다.

ex) PostgreSQL -> jdbc:postgresql://database-service:5432/dbname // 서비스 이름 사용

┌───────────────────────────────────────┐
│            Service 타입 계층          │
│                                       │
│  ┌─────────────────────────────────┐  │
│  │         LoadBalancer            │  │
│  │  ┌───────────────────────────┐  │  │
│  │  │        NodePort           │  │  │
│  │  │  ┌─────────────────────┐  │  │  │
│  │  │  │     ClusterIP       │  │  │  │
│  │  │  │     (기본 포함)     │  │  │  │
│  │  │  └─────────────────────┘  │  │  │
│  │  └───────────────────────────┘  │  │
│  └─────────────────────────────────┘  │
└───────────────────────────────────────┘
           * NodePort는 ClusterIP를 포함

그래서 내부에서는 접속 방법도 두 가지임
database-service:5432 OR 10.43.123.45:5432 (ClusterIP)

외부에서는 당연히 Private IP로 접속한다.
192.168.0.30:30432 (NodePort)
```

<br />
<br />

```
* 아이피 고정

각 VM의 아이피 고정은 DHCP 설정에서
현재 사용 중인 IP를 제외하는 (예약) 방식으로
설정하고 VM에서는 별다른 설정을 안 하는 게 좋다.
```

<br >
<br />

```
* Ingress에 rate-limit 추가 고려

ex) Ingress annotation
nginx.ingress.kubernetes.io/limit-rps: "10"
nginx.ingress.kubernetes.io/limit-connections: "100"
```

<br />
<br />

```
* Minimal (최소 설치) -> Ubuntu Server (표준 설치)

sudo unminimize 명령어를 실행하면,
Ubuntu Minimal Install (최소 설치) 상태에서 표준 Ubuntu Server 환경과 동일한 수준의 패키지 셋이 설치된다.
```
