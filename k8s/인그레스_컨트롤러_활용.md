# 인그레스 컨트롤러 활용하기

<br />
<br />

* 쿠버네티스 환경에서 Ingress Controller를 사용한 외부 트래픽 처리

---

```
Ingress 리소스의 주된 목적은 Ingress Controller를 통해,
외부 트래픽을 클러스터 내부의 특정 Service 리소스와 연결하는 것이다.

예시를 보며 실무에서 사용하는 예시를 알아보자.
```

<br />
<br />
<br />
<br />

1. 생성할 VM 사양

| 구분            | 최소 요구 사항 (테스트/저부하) | 권장 요구 사항 (실제 서비스/중간 부하) |
|:---------------:|---------------------------------|-----------------------------------------|
| vCPU	          | 1 Core                          |	2 Core                                  |
| RAM (메모리)	  | 1 GB	                          | 2 GB ~ 4 GB                             |
| 디스크 (저장소)	| 10 GB (OS + K3s)                | 20 GB ~ 40 GB                           |

<br />
<br />
<br />

2. VM 방화벽 설정

```zsh
# SSH 포트 허용 (기본 22번, 80, 443)
sudo ufw allow ssh
sudo ufw allow 80/tcp  # HTTP
sudo ufw allow 443/tcp # HTTPS

# 방화벽 활성화
sudo ufw enable

# 상태 확인
sudo ufw status
```

<br />

| 포트       | 용도                       | 방화벽 설정 권장          | 
|:----------:|----------------------------|----------------------------|
| 22 (TCP)   | VM 관리 (SSH)              | **특정 관리자 IP만 허용**  |
| 80 (TCP)   | HTTP (Ingress Controller)  | 전체 허용 (0.0.0.0/0)      |
| 443 (TCP)	 | HTTPS (Ingress Controller) | 전체 허용 (0.0.0.0/0)      |

<br />
<br />
<br />

3. Traefik 비활성화 (NGINX Ingress 사용 시 필수)

```
K3s 기본값으로 Traefik을 사용하기 때문에,
사용하지 않으려면 삭제해야 한다.
```

```zsh
curl -sfL https://get.k3s.io | sh -s - --disable traefik

# 또는 더 많은 옵션과 함께
curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="--disable traefik" sh -
```

<br />
<br />
<br />

4. MetalLB 설치 및 IP 설정

```
Helm을 사용하며, VM 환경이므로 외부 접근을 위해 Service 타입을 LoadBalancer로 설정한다.
(MetalLB가 없다면 NodePort를 사용해야 한다.)

Service 타입을 LoadBalancer로 해놓으면 나중에 클라우드(AWS) 서비스를 사용 시,
AWS ELB등을 사용하는 환경에서 마이그레이션이 편해진다.
```

```zsh
# VM 환경에서 LoadBalancer 타입 Service에 외부 IP를 할당하기 위해 MetalLB를 설치

# 설치 스크립트 다운로드
curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3

# 실행 권한 부여
chmod 700 get_helm.sh

# Helm 설치 실행 ← 이 부분 추가 필요
./get_helm.sh

# 설치 확인
helm version

# MetalLB 저장소 추가
helm repo add metallb https://metallb.github.io/metallb
helm repo update

# 필수 시스템 요소 설치
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml

# MetalLB 앱 설치
helm install metallb metallb/metallb -n metallb-system --create-namespace
```

```zsh
# MetalLB 설치 중 오류가 발생 시

# 충돌을 일으킨 ConfigMap 삭제
kubectl delete configmap metallb-excludel2 -n metallb-system

# MetalLB 설치 시 수동으로 적용했던 YAML 파일의 잔여 리소스들을 삭제
# (v0.13.12 버전의 YAML 파일을 기반으로 삭제한다.)
kubectl delete -f https://raw.githubusercontent.com/metallb/metallb/v0.13.12/config/manifests/metallb-native.yaml

# 만약 이전 설치 기록이 있다면 삭제
helm delete metallb -n metallb-system

# MetalLB 앱 설치 (Helm)
helm install metallb metallb/metallb -n metallb-system --create-namespace
```

<br />

`metallb-config.yaml 만들기 (경로 상관없음)`

```yaml
# metallb-config.yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: my-ip-pool
  namespace: metallb-system
spec:
  # 본인 공유기/VM 네트워크 대역에 맞는 남는 IP 범위로 수정 필수
  addresses:
  - 192.168.0.10-192.168.0.240
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-advertisement
  namespace: metallb-system
spec:
  ipAddressPools:
  - my-ip-pool
```

```zsh
# 파일이 이미 있다면 바로 적용
kubectl apply -f metallb-config.yaml
```

<br />
<br />
<br />

5. NGINX Ingress Controller 설치

```zsh
helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
helm repo update

# LoadBalancer 타입으로 설치
kubectl create namespace ingress-nginx
helm install ingress-nginx ingress-nginx/ingress-nginx \
  --namespace ingress-nginx \
  --set controller.service.type=LoadBalancer
```

```zsh
# 내부 IP 확인
kubectl get svc -n ingress-nginx ingress-nginx-controller

# EXTERNAL-IP 부분에 숫자로 된 IP가 떴는지 확인한다. (IP를 $INGRESS_IP라고 생각하면 된다)
```

<br />
<br />
<br />

6. 도메인 DNS 설정

```
도메인 구입처(가비아, 호스팅케이알 등)의 DNS 관리 메뉴에서
A 레코드를 추가한다.
```

<br />

| 구분       | 설명           |
|------------|----------------|
| 도메인     | healthapp.shop |
| 레코드     | A              |
| 호스트     | @              |
| 값(IP주소) | 공인IP         |

<br />
<br />
<br />

7. Cert-Manager (무료 인증서 발급기) 설치

```zsh
helm repo add jetstack https://charts.jetstack.io
helm repo update

# 최신 stable 버전 자동 설치
helm install cert-manager jetstack/cert-manager \
  --namespace cert-manager \
  --create-namespace \
  --set installCRDs=true
```

<br />

`인증서 발급자(Issuer) 설정 아래 내용을 cluster-issuer.yaml로 저장하고 적용`

```yaml
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: myemail@example.com  # ⚠️ 본인 이메일로 변경
    privateKeySecretRef:
      name: letsencrypt-prod-private-key
    solvers:
    - http01:
        ingress:
          class: nginx
```

```zsh
# 위에서 만든 인증서 발급자(Issuer) 설정 적용
kubectl apply -f cluster-issuer.yaml
```

<br />
<br />
<br />

8. 최종 연결 (Ingress 배포)

```
이제 도메인과 서비스를 연결해야 한다.
(이미 백엔드 서비스(my-health-service)는 떠 있다고 가정)
```

<br />

`final-ingress.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress # 생성하려는 리소스의 종류 (Ingress: 외부 트래픽을 클러스터 내부 서비스로 라우팅)

metadata:
  name: healthapp-ingress # Ingress 리소스의 이름 (클러스터 내에서 고유해야 함)
  annotations: # 리소스에 대한 추가적인 설정 또는 메타데이터
    # Cert-Manager에게 이 Ingress의 HTTPS 인증서 발급을 위임
    cert-manager.io/cluster-issuer: letsencrypt-prod 
    # NGINX Ingress Controller에게 HTTP로 들어오는 요청을 HTTPS(443)로 자동 리다이렉트하라고 지시
    nginx.ingress.kubernetes.io/ssl-redirect: "true" 
spec:
  ingressClassName: nginx # 이 Ingress를 처리할 Ingress Controller의 종류를 지정
  rules: # 트래픽 라우팅 규칙 목록
  - host: healthapp.shop # 이 규칙이 적용될 도메인 이름 (사용자가 접속할 주소)
    http: # HTTP 트래픽에 대한 규칙 정의
      paths: # 경로 기반 라우팅 규칙 목록
      - path: / # 모든 경로를 의미 (예: healthapp.shop/anything)
        pathType: Prefix # '/' 경로로 시작하는 모든 요청을 처리
        backend: # 트래픽을 최종적으로 전달할 목적지 서비스
          service:
            name: my-health-service # 트래픽을 전달받을 백엔드 Service의 이름
            port:
              number: 80 #Service가 외부로 노출하는 포트
  tls: # HTTPS/TLS 설정을 위한 섹션
  - hosts: # TLS 인증서를 적용할 도메인 목록
    - healthapp.shop
    # Cert-Manager가 발급받은 인증서(PEM 형식)를 저장할 Secret의 이름.
    # NGINX Controller는 이 Secret을 읽어 HTTPS 통신에 사용합니다.
    secretName: healthapp-tls-secret
```

```zsh
# Ingress 설정까지 적용
kubectl apply -f final-ingress.yaml

# Ingress 상태 확인
kubectl get ingress healthapp-ingress # ADDRESS 컬럼에 IP가 표시되어야 함

# 인증서 발급 확인
kubectl get certificate # READY가 True여야 함

# 인증서 상세 정보 확인
kubectl describe certificate healthapp-tls-secret

# cert-manager 로그 확인
kubectl logs -n cert-manager -l app=cert-manager

# 4. 브라우저에서 접속 테스트
# https://healthapp.shop
```
