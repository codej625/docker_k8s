# 인그레스 컨트롤러 활용하기

<br />
<br />

* 쿠버네티스 환경에서 Ingress Controller를 사용한 외부 트래픽 처리

---

```
Ingress 리소스의 주된 목적은 Ingress Controller를 통해,
외부 트래픽을 클러스터 내부의 특정 Service 리소스와 연결하는 것이다.

VM을 사용해서 EKS 구조를 만드는 예시이다.
(하나의 클러스터에 여러 개의 인스턴스 사용)
```

<br />
<br />
<br />
<br />

1. 생성할 VM 사양 (예시)

| VM  | 역할              | CPU    | RAM | DISK  | IP (고정)     |
|:---:|------------------|--------|-----|-------|--------------|
| VM1	|	Master + Ingress | 2 Core | 2GB | 20GB  | 192.168.0.10 |
| VM2	| Backend	         | 2 Core | 2GB | 20GB  | 192.168.0.20 |
| VM3 | DB               | 2 Core | 4GB | 50GB+ | 192.168.0.30 |

<br />
<br />
<br />

2. 각 VM 사전 설정

```zsh
# 호스트명 설정 (각 VM에서)
sudo hostnamectl set-hostname k3s-master # VM1 에서 실행

sudo hostnamectl set-hostname k3s-worker1 # VM2 에서 실행

sudo hostnamectl set-hostname k3s-worker2 # VM3 에서 실행
```

```zsh
# 방화벽 비활성화 (또는 필요 포트 오픈)
sudo ufw disable
```

```zsh
# /etc/hosts에 서로 등록 (각 VM에서)
sudo tee -a /etc/hosts << EOF
192.168.0.10 k3s-master
192.168.0.20 k3s-worker1
192.168.0.30 k3s-worker2
EOF
```

<br />
<br />
<br />

3. VM1에서 K3s Master 설치

```zsh
# Traefik 비활성화
curl -sfL https://get.k3s.io | sh -s - --disable traefik

# 설치 확인
sudo kubectl get nodes

# 토큰 확인 (VM2, VM3 조인에 필요함)
sudo cat /var/lib/rancher/k3s/server/node-token
```

```zsh
# kubectl 권한 설정 (편의상)
mkdir -p ~/.kube
sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
sudo chown $(id -u):$(id -g) ~/.kube/config
```

<br />
<br />
<br />

4. VM2, VM3에서 K3s Worker 조인

<br />

`VM2에서 실행`

```zsh
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.0.10:6443 K3S_TOKEN="여기에_토큰_붙여넣기" sh -
```

<br />

`VM3에서 실행`

```zsh
curl -sfL https://get.k3s.io | K3S_URL=https://192.168.0.10:6443 K3S_TOKEN="여기에_토큰_붙여넣기" sh -
```

<br />

`VM1에서 확인`

```zsh
# 노드 리스트 출력
kubectl get nodes
```

<br />

| NAME        | STATUS | ROLES                | AGE | VERSION |
|-------------|--------|----------------------|-----|---------|
| k3s-master  | Ready  | control-plane,master | 5m  | v1.28.x |
| k3s-worker1 | Ready  | <none>               | 2m  | v1.28.x |
| k3s-worker2 | Ready  | <none>               | 1m  | v1.28.x |

<br />
<br />
<br />

5. VM1에서 노드 라벨링

```zsh
# VM1은 Ingress
kubectl label nodes k3s-master role=ingress

# VM2는 Backend
kubectl label nodes k3s-worker1 role=backend

# VM3는 DB
kubectl label nodes k3s-worker2 role=database

# 확인
kubectl get nodes --show-labels
```

<br />
<br />
<br />

6. NGINX Ingress Controller 설치

```zsh
# NGINX Ingress 설치 (베어메탈용)
kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.9.4/deploy/static/provider/baremetal/deploy.yaml
```

```zsh
# Ingress Controller를 VM1(Master)에만 배치하려면

# 패치로 nodeSelector 추가
kubectl patch deployment ingress-nginx-controller -n ingress-nginx --type='json' -p='[
  {
    "op": "add",
    "path": "/spec/template/spec/nodeSelector",
    "value": {"role": "ingress"}
  }
]'
```

```zsh
# 설치 확인
kubectl get pods -n ingress-nginx
kubectl get svc -n ingress-nginx
```

<br />

| NAME                     | TYPE     | CLUSTER-IP  | EXTERNAL-IP | PORT(S)                    | AGE |
|--------------------------|----------|-------------|-------------|----------------------------|-----|
| ingress-nginx-controller | NodePort | 10.43.xx.xx | <none>      | 80:30080/TCP,443:30443/TCP | 1m  |

<br />
<br />
<br />

7. Backend Service 설정

<br />

`ex) backend-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: default
spec:
  type: ClusterIP # 내부 통신용 (Ingress가 라우팅)
  selector:
    app: backend # Deployment의 label과 일치해야 함
  ports:
  - name: http
    port: 80 # 서비스 포트
    targetPort: 8080 # 컨테이너 포트
    protocol: TCP
```

```zsh
kubectl apply -f backend-service.yaml
```

<br />
<br />
<br />

8. DB Service 설정 (외부 DBA 접근 가능해야 함)

<br />

`ex) database-service.yaml`

```yaml
apiVersion: v1
kind: Service
metadata:
  name: database-service
  namespace: default
spec:
  type: NodePort # 외부에서 DBeaver 접근용!
  selector:
    app: database # Deployment의 label과 일치해야 함
  ports:
  - name: postgres
    port: 5432 # 서비스 포트
    targetPort: 5432 # 컨테이너 포트
    nodePort: 30432 # 외부 접근 포트 (30000-32767 범위 사이)
    protocol: TCP
```

```zsh
kubectl apply -f database-service.yaml
```

<br />
<br />
<br />

9. Ingress 라우팅 설정

<br />

`ex) ingress.yaml`

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
  namespace: default
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
spec:
  ingressClassName: nginx
  rules:
  - host: healthapp.shop # 도메인 사용 시
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
  # IP로 직접 접근하려면 host 없이
  - http:
      paths:
      - path: /api
        pathType: Prefix
        backend:
          service:
            name: backend-service
            port:
              number: 80
```

```zsh
kubectl apply -f ingress.yaml
```

<br />
<br />
<br />

10. 최종 구조 및 접근 방법

```
외부 사용자
    │
    ▼ http://192.168.0.10:30080/api
┌─────────────────────────────────────────────────────┐
│  K3s 클러스터                                         │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │
│  │ VM1         │  │ VM2         │  │ VM3         │  │
│  │ Master      │  │ Worker      │  │ Worker      │  │
│  │             │  │             │  │             │  │
│  │ NGINX       │  │ Backend     │  │ PostgreSQL  │  │
│  │ Ingress ────┼──▶ (ClusterIP)─┼──▶ (NodePort)  │  │
│  │ :30080      │  │ :80         │  │ :30432      │  │
│  └─────────────┘  └─────────────┘  └──────┬──────┘  │
│                                           │         │
└───────────────────────────────────────────┼─────────┘
                                            │
                                      ┌─────┴──────────────┐
                                      │ DBeaver            │
                                      │ 192.168.0.30:30432 │
                                      └────────────────────┘
```

<br />
<br />
<br />

11. 도메인 DNS 설정

```
도메인 구입처(가비아, 호스팅케이알 등)의 DNS 관리 메뉴에서
A 레코드를 추가한다.
```

<br />

| 구분      | 설명            |
|----------|----------------|
| 도메인     | healthapp.shop |
| 레코드     | A              |
| 호스트     | @              |
| 값(IP주소) | 공인IP          |

<br />
<br />
<br />

12. 팁

```
백엔드에서 디비 서버를 붙일때는
서비스 이름으로 지정해놓으면 된다.

ex) PostgreSQL -> jdbc:postgresql://database-service:5432/dbname // 서비스 이름 사용

┌───────────────────────────────────────┐
│            Service 타입 계층            │
│                                       │
│  ┌─────────────────────────────────┐  │
│  │         LoadBalancer            │  │
│  │  ┌───────────────────────────┐  │  │
│  │  │        NodePort           │  │  │
│  │  │  ┌─────────────────────┐  │  │  │
│  │  │  │     ClusterIP       │  │  │  │
│  │  │  │     (기본 포함)       │  │  │  │
│  │  │  └─────────────────────┘  │  │  │
│  │  └───────────────────────────┘  │  │
│  └─────────────────────────────────┘  │
└───────────────────────────────────────┘
              * NodePort는 ClusterIP를 포함

그래서 내부에서는 접속 방법도 두 가지임
database-service:5432 OR 10.43.123.45:5432 (ClusterIP)

외부에서는 당연히 Private IP로 접속한다.
192.168.0.30:30432 (NodePort)
```

<br />

```
각 VM의 아이피 고정은 DHCP 설정에서
현재 사용 중인 IP를 제외하는 (예약) 방식으로
설정하고 VM에서는 별다른 설정을 안 하는 게 좋다.
```
