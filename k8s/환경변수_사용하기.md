# 쿠버네티스에서 환경변수를 사용하는 방법

<br />
<br />

* env를 쿠버네티스에서 관리해보자.

---

```
기본적으로 쿠버네티스로 컨테이너를 관리할 때는
별도의 env파일을 쿠버네티스에서 관리하도록 권장한다.

쿠버네티스에서 환경변수 관리 방법을 알아보자.
```

<br />
<br />
<br />
<br />

1. 백엔드(Spring Boot) 서버에 환경변수 등록해 사용하기

<br />

`Spring Boot 프로젝트 셋팅`

```
# 사이트에 접속한다.
https://start.spring.io/

# 의존성은 Spring Web, Spring Boot DevTools를 선택한다.
```

<br />
<br />
<br />

2. 간단한 코드 작성

<br />

`AppController.java`

```java
package com.example.demo;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AppController {

    private final Constants constants;

    public AppController(Constants constants) {
        this.constants = constants;
    }

    @GetMapping("/")
    public String hello() {
        return "my account is " + constants.getMyAccount() + " and my password is " + constants.getMyPassword();
    }
}
```

<br />

`Constants.java`

```java
package com.example.demo;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Component
public class Constants {
    @Value("${MY_ACCOUNT:default}")
    private String myAccount;

    @Value("${MY_PASSWORD:default}")
    private String myPassword;

    public String getMyAccount() {
        return myAccount;
    }

    public String getMyPassword() {
        return myPassword;
    }
}
```

<br />
<br />
<br />

2. 프로젝트 실행시켜보기

```
# 환경변수 파일을 찾을 수 없기 때문에 default가 뜰 것이다.
"my account is default and my password is default"
```

<br />
<br />
<br />

3. Dockerfile 작성하기

<br />

`Dockerfile`

```
FROM openjdk:17-jdk

COPY build/libs/*SNAPSHOT.jar app.jar

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

<br />
<br />
<br />

4. Spring Boot 프로젝트 빌드하기

```
# 클린 빌드를 한다.
$ ./gradlew clean build
```

<br />
<br />
<br />

5. Dockerfile을 바탕으로 이미지 빌드하기

```
# 태그를 1.0으로 지정하고, 도커 이미지를 빌드한다.
$ docker build -t spring-server:1.0 .
```

<br />
<br />
<br />

6. 매니페스트 파일 작성하기

<br />

`spring-deployment.yaml`

```yaml
apiVersion: apps/v1
kind: Deployment

# Deployment 기본 정보
metadata:
  name: spring-deployment # Deployment 이름

# Deployment 세부 정보
spec:
  replicas: 3 # 생성할 파드의 복제본 개수
  selector:
    matchLabels:
      app: spring-server # 아래에서 정의한 Pod 중 'app: backend-app'이라는 값을 가진 파드를 선택

  template:
    metadata:
      labels: # 레이블 (= 카테고리)
        app: spring-server 
    spec:
      containers:
        - name: spring-container # 컨테이너 이름
          image: spring-server:1.0 # 컨테이너를 생성할 때 사용할 이미지
          imagePullPolicy: IfNotPresent # 로컬에서 이미지를 먼저 가져온다. 없으면 레지스트리에서 가져온다.
          ports:
            - containerPort: 8080 # 컨테이너에서 사용하는 포트를 명시적으로 표현
          env: # 환경변수 등록
            - name: MY_ACCOUNT
              value: "codej625"
            - name: MY_PASSWORD
              value: "1234"
```

<br />

`spring-service.yaml`

```yaml
apiVersion: v1
kind: Service

# Service 기본 정보
metadata:
  name: spring-service

# Service 세부 정보
spec:
  type: NodePort # Service의 종류
  selector:
    app: spring-server # 실행되고 있는 파드 중 'app: backend-app'이라는 값을 가진 파드와 서비스를 연결
  ports:
    - protocol: TCP # 서비스에 접속하기 위한 프로토콜
      nodePort: 30080 # 외부에서 사용자들이 접근하게 될 포트 번호
      port: 8080 # 쿠버네티스 내부에서 Service에 접속하기 위한 포트 번호
      targetPort: 8080 # 매핑하기 위한 파드의 포트 번호
```

<br />
<br />
<br />

7. 매니페스트 기반으로 실행시키기

```
$ kubectl apply -f spring-deployment.yaml
$ kubectl apply -f spring-service.yaml
```

<br />
<br />
<br />

8. 환경변수가 잘 적용됐는 지 확인해보기

```
# env에 명시한 값을 보여준다.
"my account is codej625 and my password is 1234"
```

<br />
<br />
<br />

9. 파드 내부로 접속해서 확인해보기

```
$ kubectl get pods # 파드명 확인하기
$ kubectl exec -it [파드명] -- bash # 파드 내부로 접속하기
$ env # 환경변수 조회
```
