# 디플로이먼트를 활용해보자.

<br />
<br />

* 디플로이먼트를 이용한 서버의 수평적 확장

---

```
실제 서비스를 운영하다보면 트래픽이 증가해서 서버가 버벅거리는 경우가 생긴다.

이 때는 서버를 수평적 확장(서버의 개수를 늘리는 방식)을 통해 해결한다.

이런 상황을 가정해 백엔드 서버인 Spring Boot 서버를 3대로 늘려보자.
```

<br />
<br />
<br />
<br />

1. 디플로이먼트를 활용해 백엔드(Spring Boot) 서버 3개 띄워보기

<br />

`spring-deployment.yaml`

```yaml
apiVersion: apps/v1 # 공식 문서에 내용 적용
kind: Deployment # 공식 문서에 내용 적용

# Deployment 기본 정보
metadata:
  name: spring-deployment # Deployment 이름

# Deployment 세부 정보
spec:
  replicas: 3 # 생성할 파드의 복제본 개수
  selector:
    matchLabels:
      app: backend-app # 아래에서 정의한 Pod 중 "backend-app"이라는 값을 가진 파드를 선택

  # 배포할 Pod 정의
  template:
    metadata:
      labels: # 레이블 (= 카테고리)
        app: backend-app # 위에서 사용
      spec:
        containers:
          - name: spring-container # 컨테이너 이름
          image: spring-server # 컨테이너를 생성할 때 사용할 이미지
          imagePullPolicy: IfNotPresent # 로컬에서 이미지를 먼저 가져온다. 없으면 레지스트리에서 가져온다.
          ports:
          - containerPort: 8080 # 컨테이너에서 사용하는 포트를 명시적으로 표현
```

<br />
<br />
<br />

2. 매니페스트 파일을 기반으로 디플로이먼트(Deployment) 생성하기

```
# 위에서 만든 매니페스트 적용
$ kubectl apply -f spring-deployment.yaml
```

<br />
<br />
<br />

3. 디플로이먼트, 레플리카셋, 파드가 잘 생성됐는 지 확인

```
# 디플로이먼트 확인
$ kubectl get deployment
```

| NAME              | READY | UP-TO-DATE | AVAILABLE | AGE |
|-------------------|-------|------------|-----------|-----|
| spring-deployment | 3/3   | 3          | 3         | 3m  |

<br />

```
# 레플리카셋 확인
$ kubectl get replicaset
```

| NAME                        | DESIRED | CURRENT | READY | AGE  |
|-----------------------------|---------|---------|-------|------|
| spring-deployment-7565bdff49 | 3       | 3       | 3     | 3m4s |

<br />

```
# 파드 확인
$ kubectl get pods
```

| NAME                              | READY | STATUS  | RESTARTS | AGE  |
|-----------------------------------|-------|---------|----------|------|
| spring-deployment-7565bdff49-bpjjz | 1/1   | Running | 0        | 3m6s |
| spring-deployment-7565bdff49-lnrnb | 1/1   | Running | 0        | 3m6s |
| spring-deployment-7565bdff49-nf9ds | 1/1   | Running | 0        | 3m6s |

<br />
<br />

```
deployment와 replicaset은 이름을 명시하지 않아서 자동으로 만들어준 것을 알 수 있다.
```

<br />
<br />
<br />

```
백엔드 서버 3개를 각각의 파드에 띄웠다.

실제 요청을 보낼 때는 각 서버에 균등하게 트래픽이 분배되어야 한다.

따라서 파드 앞단에 알아서 여러 파드에 균등하게 요청을 분배해줄 무언가가 필요하다.

쿠버네티스에서는 서비스(Service)가 여러 파드에 균등하게 요청을 분배해주는 역할을 한다.
```
