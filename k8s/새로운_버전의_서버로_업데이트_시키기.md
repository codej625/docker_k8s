# 새로운 버전의 서버로 업데이트 시키기

<br />
<br />

* 실제 서버를 운영하다보면 기능을 업데이트를 할 일이 많이 발생한다.

```
쿠버네티스에서는 새로운 버전의 백엔드 서버를
어떻게 업데이트 시키는 지 알아보자
```

<br />
<br />
<br />
<br />

1. 코드 수정하기

<br />

`AppController.java`

```java
package com.example.demo;

import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class AppController {
  @GetMapping("/")
  public String home() {
    return "Version 1.0"; // 기존 0.1 -> 1.0 으로 변경
  }
}
```

<br />
<br />
<br />

2. Spring Boot 프로젝트 다시 빌드하기

```
# gradle 빌드 명령어
$ ./gradlew clean build
```

<br />
<br />
<br />

3. 빌드된 jar 파일을 기반으로 새로 이미지 빌드하기

```
# 1.0 이라는 태그를 달아준다.
$ docker build -t spring-server:1.0 .
```

<br />
<br />
<br />

4. 이미지가 잘 생성됐는 지 확인하기

```
# 도커 이미지 확인
$ docker image ls
```

<br />
<br />
<br />

5. 기존 매니페스트 파일 수정하기

<br />

`spring-deployment.yaml`

```
apiVersion: apps/v1
kind: Deployment

metadata:
  name: spring-deployment

spec:
  replicas: 5

  selector:
    matchLabels:
    app: backend-app

  template:
    metadata:
      labels:
        app: backend-app
    spec:
      containers:
      - name: spring-container
        image: spring-server:1.0
        imagePullPolicy: IfNotPresent
        ports:
          - containerPort: 8080
```

<br />
<br />
<br />

6. 수정된 매니페스트 파일을 기반으로 업데이트하기

```
# yaml 파일 적용하기
$ kubectl apply -f spring-deployment.yaml
```

<br />
<br />
<br />

7. 확인

```
# 업데이트 됐는 지 확인하기 위해 브라우저에서 확인한다.
localhost:[nodePort] # 서비스 명시한 nodePort
```
