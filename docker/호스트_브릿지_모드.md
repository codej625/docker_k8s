# 도커 네트워크 격리와 호스트 모드 이해하기

<br />
<br />

* FastAPI 애플리케이션을 도커 컨테이너로 띄우고 네트워크 접근 방법 알아보기

---

```
도커에서 컨테이너의 네트워크는 기본적으로 격리되어 있어 외부에서 바로 접근할 수 없다.
이를 해결하기 위해 포트 매핑(-p) 또는 호스트 네트워크 모드(--network host)를 사용할 수 있다.

이번 예제에서는 FastAPI 애플리케이션을 도커 컨테이너로 실행하고,
기본 bridge 모드와 host 모드를 비교해 보며 네트워크 접근 방법을 알아보자
```

<br />
<br />
<br />
<br />

1. FastAPI 애플리케이션과 Dockerfile 준비

<br />

`main.py`

```py
from fastapi import FastAPI

app = FastAPI()

@app.get("/")
def read_root():
    return {"message": "Hello from FastAPI"}
```

<br />

`Dockerfile`

```dockerfile
FROM python:3.9
WORKDIR /app
COPY . /app
RUN pip install fastapi uvicorn
EXPOSE 8000
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

<br />
<br />

```
- main.py: 간단한 FastAPI 애플리케이션으로, 루트 경로(/)에 접근 시 JSON 응답을 반환한다.

- Dockerfile: Python 3.9 기반으로 FastAPI와 uvicorn을 설치하고, 8000번 포트에서 실행하도록 설정

- --host 0.0.0.0: 컨테이너 내부에서 모든 IP로 요청을 수신하도록 설정.

- EXPOSE 8000: 컨테이너가 8000번 포트를 사용함을 명시 (문서화 용도).
```

<br />
<br />
<br />


2. 도커 이미지 빌드 및 컨테이너 실행

<br />

`도커 이미지 빌드`

```
$ docker build -t my-fastapi-image .
```

<br />

`bridge 모드에서 컨테이너 실행 (포트 매핑)`

```
$ docker run -d -p 8000:8000 my-fastapi-image
```

<br />

`host 모드에서 컨테이너 실행`

```
$ docker run -d --network host my-fastapi-image
```

<br />
<br />

```
- bridge 모드: -p 8000:8000으로 호스트의 8000번 포트를 컨테이너의 8000번 포트에 매핑.

- host 모드: --network host로 호스트의 네트워크를 공유해 포트 매핑 없이 바로 접근 가능.
```

<br />
<br />
<br />

3. 컨테이너 접근 확인

<br />

`bridge 모드에서 확인`

```
$ curl http://localhost:8000

// {"message": "Hello from FastAPI"}
```

<br />

`host 모드에서 확인`

```
$ curl http://localhost:8000

// {"message": "Hello from FastAPI"}
```

<br />

| 모드 | 접근 | 설명 |
|-----|-----|-----|
| bridge | http://localhost:8000 | 포트 매핑(-p 8000:8000) 필요, 컨테이너 네트워크와 호스트 네트워크 격리 |
| host | http://localhost:8000 | 포트 매핑 불필요, 호스트의 네트워크를 공유 |

<br />
<br />

```
- bridge 모드: 컨테이너의 네트워크는 호스트와 격리되어 있어, 포트 매핑 없이는 localhost:8000으로 접근 불가.

- host 모드: 컨테이너가 호스트의 네트워크를 공유하므로, localhost:8000으로 바로 접근 가능.
```

<br />
<br />
<br />

4. 정리

<br />

`접근 방법`

```
- bridge 모드: docker run -p 8000:8000으로 포트 매핑 후 접근.

- host 모드: docker run --network host로 실행 후 바로 접근.

- 컨테이너 내부로 들어가서 확인: docker exec -it <container_id> bash 후 curl http://localhost:8000.
```

<br />

`주의`

```
- host 모드는 네트워크 격리가 없으므로 보안에 주의해야 한다.

- host 모드에서는 호스트의 포트가 이미 사용 중이면 충돌 가능성이 있다.
```
